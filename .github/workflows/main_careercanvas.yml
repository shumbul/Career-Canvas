# Career Canvas - Complete Project CI/CD Pipeline
# Builds and deploys the full-stack application to Azure Web App

name: Build and Deploy Career Canvas to Azure

on:
  push:
    branches:
      - main
    paths:
      - 'frontend/**'
      - 'backend/**'
      - 'index.js'
      - 'package.json'
      - '.github/workflows/main_careercanvas.yml'
  pull_request:
    branches: 
      - main
    paths:
      - 'frontend/**'
      - 'backend/**'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

env:
  AZURE_WEBAPP_NAME: 'CareerCanvas'
  NODE_VERSION: '18.x'
  AZURE_WEBAPP_PACKAGE_PATH: './deployment-package'

jobs:
  build:
    name: Build Complete Application
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
      - name: üöÄ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üü¢ Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: |
            frontend/package-lock.json
            backend/package-lock.json
            package-lock.json

      # Build Frontend
      - name: üì¶ Install Frontend Dependencies
        run: |
          cd frontend
          npm ci --production=false

      - name: üî® Build Frontend Application
        run: |
          cd frontend
          npm run build
        env:
          CI: false
          GENERATE_SOURCEMAP: false

      - name: ‚úÖ Test Frontend (if tests exist)
        run: |
          cd frontend
          npm test -- --coverage --passWithNoTests --watchAll=false || true
        continue-on-error: true

      # Build Backend
      - name: ‚öôÔ∏è Install Backend Dependencies
        run: |
          cd backend
          npm ci --production=false

      - name: üîß Build Backend Functions
        run: |
          cd backend
          npm run build

      - name: üß™ Test Backend (if tests exist)
        run: |
          cd backend
          npm test || echo "No backend tests found"
        continue-on-error: true

      # Install Root Dependencies
      - name: üìã Install Root Dependencies
        run: |
          npm ci --production=false

      # Create Deployment Package
      - name: üìÅ Create Deployment Package
        run: |
          echo "Creating deployment package..."
          mkdir -p deployment-package
          
          # Copy root files
          cp index.js deployment-package/
          cp package.json deployment-package/
          cp README.md deployment-package/
          cp LICENSE deployment-package/ || true
          
          # Copy frontend build (ensure it exists)
          if [ -d "frontend/build" ]; then
            cp -r frontend/build deployment-package/build
            echo "‚úÖ Frontend build copied"
          else
            echo "‚ùå Frontend build not found!"
            exit 1
          fi
          
          # Copy backend compiled files (ensure it exists)
          if [ -d "backend/dist" ]; then
            cp -r backend/dist deployment-package/dist
            cp backend/host.json deployment-package/
            cp backend/package.json deployment-package/backend-package.json
            echo "‚úÖ Backend build copied"
          else
            echo "‚ùå Backend build not found!"
            exit 1
          fi
          
          # Create web.config for Azure App Service IIS
          cat > deployment-package/web.config << 'EOF'
          <?xml version="1.0" encoding="utf-8"?>
          <configuration>
            <system.webServer>
              <webSocket enabled="false" />
              <handlers>
                <add name="iisnode" path="index.js" verb="*" modules="iisnode"/>
              </handlers>
              <rewrite>
                <rules>
                  <!-- Handle static files -->
                  <rule name="StaticContent">
                    <conditions>
                      <add input="{REQUEST_FILENAME}" matchType="IsFile" />
                    </conditions>
                    <action type="None" />
                  </rule>
                  <!-- Handle API routes -->
                  <rule name="ApiRoutes" stopProcessing="true">
                    <match url="^api/(.*)$" />
                    <action type="Rewrite" url="index.js" />
                  </rule>
                  <!-- Handle React Router routes -->
                  <rule name="ReactRoutes" stopProcessing="true">
                    <match url=".*" />
                    <conditions logicalGrouping="MatchAll">
                      <add input="{REQUEST_FILENAME}" matchType="IsFile" negate="true" />
                      <add input="{REQUEST_FILENAME}" matchType="IsDirectory" negate="true" />
                      <add input="{REQUEST_URI}" pattern="^/api" negate="true" />
                    </conditions>
                    <action type="Rewrite" url="/build/index.html" />
                  </rule>
                </rules>
              </rewrite>
              <defaultDocument>
                <files>
                  <clear />
                  <add value="index.js" />
                </files>
              </defaultDocument>
              <httpErrors existingResponse="PassThrough" />
              <iisnode 
                watchedFiles="web.config;*.js"
                loggingEnabled="true"
                debuggingEnabled="false"
                devErrorsEnabled="false"
                node_env="production"
              />
            </system.webServer>
          </configuration>
          EOF
          
          echo "‚úÖ Deployment package created successfully"
          ls -la deployment-package/

      - name: üìä Validate Build Artifacts
        run: |
          echo "üîç Validating deployment package..."
          
          # Check required files
          required_files=("index.js" "package.json" "web.config")
          for file in "${required_files[@]}"; do
            if [ -f "deployment-package/$file" ]; then
              echo "‚úÖ Found: $file"
            else
              echo "‚ùå Missing: $file"
              exit 1
            fi
          done
          
          # Check required directories
          required_dirs=("build" "dist")
          for dir in "${required_dirs[@]}"; do
            if [ -d "deployment-package/$dir" ]; then
              echo "‚úÖ Found directory: $dir"
            else
              echo "‚ùå Missing directory: $dir"
              exit 1
            fi
          done
          
          echo "üì¶ Package size: $(du -sh deployment-package | cut -f1)"
          echo "üéâ Build validation completed successfully!"

      - name: üì§ Upload Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: career-canvas-build-${{ github.sha }}
          path: deployment-package/
          retention-days: 30
          compression-level: 6

  deploy:
    name: Deploy to Azure Web App
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'
    environment: 
      name: ${{ github.event.inputs.environment || 'production' }}
      url: https://careercanvas.azurewebsites.net
    permissions:
      id-token: write
      contents: read

    steps:
      - name: üì• Download Build Artifact
        uses: actions/download-artifact@v4
        with:
          name: career-canvas-build-${{ github.sha }}
          path: ./deployment-package

      - name: üîê Login to Azure using Managed Identity
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZUREAPPSERVICE_CLIENTID_79EF182CA2BA4AFC95372192166A099E }}
          tenant-id: ${{ secrets.AZUREAPPSERVICE_TENANTID_DD224BD36AFD4CABB528C37B0F2708FA }}
          subscription-id: ${{ secrets.AZUREAPPSERVICE_SUBSCRIPTIONID_70926F53F26E4DF282C5CFC7DBAB15C3 }}

      - name: üîß Configure Azure App Service Settings
        run: |
          echo "Configuring Azure App Service settings..."
          
          # Set Node.js version and environment variables
          az webapp config appsettings set \
            --resource-group $(az webapp show --name ${{ env.AZURE_WEBAPP_NAME }} --query resourceGroup -o tsv) \
            --name ${{ env.AZURE_WEBAPP_NAME }} \
            --settings \
              WEBSITE_NODE_DEFAULT_VERSION="~18" \
              NODE_ENV="production" \
              WEBSITE_RUN_FROM_PACKAGE="1" \
              SCM_DO_BUILD_DURING_DEPLOYMENT="false" \
              ENABLE_ORYX_BUILD="false" \
              WEBSITE_WEBDEPLOY_USE_SCM="false"

      - name: üöÄ Deploy to Azure Web App
        id: deploy-to-webapp
        uses: azure/webapps-deploy@v3
        with:
          app-name: ${{ env.AZURE_WEBAPP_NAME }}
          slot-name: 'Production'
          package: ./deployment-package
          clean: true

      - name: üè• Post-Deployment Health Check
        run: |
          echo "üè• Running health checks..."
          
          # Wait for application to start
          sleep 30
          
          # Health check URLs
          BASE_URL="https://careercanvas.azurewebsites.net"
          
          echo "Testing frontend..."
          if curl -f -s -o /dev/null "$BASE_URL/"; then
            echo "‚úÖ Frontend is responding"
          else
            echo "‚ùå Frontend health check failed"
          fi
          
          echo "Testing API health endpoint..."
          if curl -f -s -o /dev/null "$BASE_URL/api/hello"; then
            echo "‚úÖ API health endpoint is responding"
          else
            echo "‚ö†Ô∏è API health endpoint is not responding (this might be expected if not implemented)"
          fi
          
          echo "Testing database connection..."
          if curl -f -s -o /dev/null "$BASE_URL/api/testConnection"; then
            echo "‚úÖ Database connection is working"
          else
            echo "‚ö†Ô∏è Database connection test failed (check MongoDB configuration)"
          fi

      - name: üìù Deployment Summary
        run: |
          echo "## üéâ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Application**: Career Canvas" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: ${{ github.event.inputs.environment || 'production' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **URL**: https://careercanvas.azurewebsites.net" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Deployed by**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Deployment time**: $(date -u)" >> $GITHUB_STEP_SUMMARY

  notify:
    name: Post-Deployment Notification
    runs-on: ubuntu-latest
    needs: [build, deploy]
    if: always() && (needs.build.result == 'success' || needs.deploy.result != 'skipped')
    
    steps:
      - name: üì¢ Deployment Status Notification
        run: |
          if [ "${{ needs.deploy.result }}" == "success" ]; then
            echo "üéâ Career Canvas successfully deployed to production!"
            echo "üåê Application URL: https://careercanvas.azurewebsites.net"
          elif [ "${{ needs.deploy.result }}" == "failure" ]; then
            echo "‚ùå Career Canvas deployment failed!"
            echo "Please check the deployment logs for details."
          else
            echo "üìã Career Canvas build completed. Deployment was skipped."
          fi
          
# Career Canvas - Build Validation
# Validates builds on pull requests without deployment

name: Build Validation & Testing

on:
  pull_request:
    branches: [main, develop]
    paths:
      - 'frontend/**'
      - 'backend/**'
      - 'index.js'
      - 'package.json'
  workflow_dispatch:

env:
  NODE_VERSION: '18.x'

jobs:
  validate-frontend:
    name: Validate Frontend
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install Frontend Dependencies
        run: |
          cd frontend
          npm ci

      - name: Lint Frontend Code
        run: |
          cd frontend
          npm run lint || echo "Linting completed with warnings"
        continue-on-error: true

      - name: Run Frontend Tests
        run: |
          cd frontend
          npm test -- --coverage --passWithNoTests --watchAll=false
        continue-on-error: true

      - name: Build Frontend
        run: |
          cd frontend
          npm run build
        env:
          CI: false

      - name: Check Build Size
        run: |
          cd frontend/build
          echo "Frontend build size:"
          du -sh . || echo "Build size check completed"

  validate-backend:
    name: Validate Backend
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json

      - name: Install Backend Dependencies
        run: |
          cd backend
          npm ci

      - name: Lint Backend Code
        run: |
          cd backend
          npm run lint || echo "Backend linting completed"
        continue-on-error: true

      - name: Run Backend Tests
        run: |
          cd backend
          npm test || echo "No backend tests found"
        continue-on-error: true

      - name: Build Backend
        run: |
          cd backend
          npm run build

      - name: Validate Backend Functions
        run: |
          echo "Validating compiled backend functions..."
          ls -la backend/dist/functions/ || echo "Functions validation completed"

  validate-integration:
    name: Validate Integration
    runs-on: ubuntu-latest
    needs: [validate-frontend, validate-backend]
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Full Integration Build
        run: |
          # Build everything
          cd frontend && npm ci && npm run build && cd ..
          cd backend && npm ci && npm run build && cd ..
          npm ci
          
          # Test deployment package creation
          mkdir -p test-deployment
          cp index.js package.json test-deployment/
          cp -r frontend/build test-deployment/build
          cp -r backend/dist test-deployment/dist
          cp backend/host.json test-deployment/
          
          echo "âœ… Integration build successful"

      - name: Security Audit
        run: |
          echo "Running security audit..."
          cd frontend && npm audit --audit-level=high || echo "Frontend audit completed"
          cd ../backend && npm audit --audit-level=high || echo "Backend audit completed"
          cd .. && npm audit --audit-level=high || echo "Root audit completed"
        continue-on-error: true

  validate-config:
    name: Validate Configuration
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Validate JSON Files
        run: |
          echo "Validating JSON configuration files..."
          
          # Validate package.json files
          node -pe "JSON.parse(require('fs').readFileSync('package.json'))" && echo "âœ… Root package.json is valid"
          node -pe "JSON.parse(require('fs').readFileSync('frontend/package.json'))" && echo "âœ… Frontend package.json is valid"
          node -pe "JSON.parse(require('fs').readFileSync('backend/package.json'))" && echo "âœ… Backend package.json is valid"
          
          # Validate other JSON files
          node -pe "JSON.parse(require('fs').readFileSync('backend/host.json'))" && echo "âœ… host.json is valid"
          
          echo "âœ… All configuration files are valid"

      - name: Check Environment Configuration
        run: |
          echo "Checking environment configuration..."
          
          # Check for required files
          test -f "index.js" && echo "âœ… Entry point (index.js) exists"
          test -f "backend/host.json" && echo "âœ… Azure Functions config exists"
          
          # Check CI/CD configuration
          test -f ".github/workflows/main_careercanvas.yml" && echo "âœ… Main CI/CD workflow exists"
          
          echo "âœ… Environment configuration check completed"

  pr-summary:
    name: PR Build Summary
    runs-on: ubuntu-latest
    needs: [validate-frontend, validate-backend, validate-integration, validate-config]
    if: always()
    
    steps:
      - name: Generate PR Summary
        run: |
          echo "## ðŸ“‹ Build Validation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.validate-frontend.result }}" == "success" ]; then
            echo "âœ… **Frontend**: Build successful" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Frontend**: Build failed" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.validate-backend.result }}" == "success" ]; then
            echo "âœ… **Backend**: Build successful" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Backend**: Build failed" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.validate-integration.result }}" == "success" ]; then
            echo "âœ… **Integration**: Build successful" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Integration**: Build failed" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.validate-config.result }}" == "success" ]; then
            echo "âœ… **Configuration**: Valid" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Configuration**: Invalid" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Ready for deployment**: ${{ needs.validate-frontend.result == 'success' && needs.validate-backend.result == 'success' && needs.validate-integration.result == 'success' && needs.validate-config.result == 'success' }}" >> $GITHUB_STEP_SUMMARY